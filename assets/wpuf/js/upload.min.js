!function(e){window.WPUF_Uploader=function(t,i,r,o,n,a){if(this.removed_files=[],this.container=i,this.browse_button=t,this.max=r||1,this.count=e("#"+i).find(".wpuf-attachment-list > li").length,this.perFileCount=0,e("#"+t).length)return this.uploader=new plupload.Uploader({runtimes:"html5,html4",browse_button:t,container:i,multipart:!0,multipart_params:{action:"wpuf_file_upload",form_id:e("#"+t).data("form_id")},max_file_count:2,multiple_queues:!1,multi_selection:"wpuf-avatar-pickfiles"!=t&&"wpuf-featured_image-pickfiles"!=t,urlstream_upload:!0,file_data_name:"wpuf_file",max_file_size:a+"kb",url:wpuf_frontend_upload.plupload.url+"&type="+o,flash_swf_url:wpuf_frontend_upload.flash_swf_url,filters:[{title:"Allowed Files",extensions:n}]}),this.uploader.bind("Init",e.proxy(this,"init")),this.uploader.bind("FilesAdded",e.proxy(this,"added")),this.uploader.bind("QueueChanged",e.proxy(this,"upload")),this.uploader.bind("UploadProgress",e.proxy(this,"progress")),this.uploader.bind("Error",e.proxy(this,"error")),this.uploader.bind("FileUploaded",e.proxy(this,"uploaded")),this.uploader.init(),e("#"+i).on("click","a.attachment-delete",e.proxy(this.removeAttachment,this)),this.uploader},WPUF_Uploader.prototype={init:function(t,i){this.showHide(),e("#"+this.container).prepend('<div class="wpuf-file-warning"></div>')},showHide:function(){if(this.count>=this.max)return this.count,this.max,e("#"+this.container+" .wpuf-file-warning").html(wpuf_frontend_upload.warning),void e("#"+this.container).find(".file-selector").hide();e("#"+this.container+" .wpuf-file-warning").html(""),e("#"+this.container).find(".file-selector").show()},added:function(t,i){var r=e("#"+this.container).find(".wpuf-attachment-upload-filelist");this.showHide(),e.each(i,function(e,t){r.append('<div class="upload-item" id="'+t.id+'"><div class="progress progress-striped active"><div class="bar"></div></div><div class="filename original">'+t.name+" ("+plupload.formatSize(t.size)+") <b></b></div></div>")}),t.refresh(),t.start()},upload:function(e){this.count=e.files.length-this.removed_files.length,this.showHide()},progress:function(t,i){var r=e("#"+i.id);e(".bar",r).css({width:i.percent+"%"}),e(".percent",r).html(i.percent+"%")},error:function(t,i){e("#"+this.container).find("#"+i.file.id).remove();var r="";switch(i.code){case-600:r=wpuf_frontend_upload.plupload.size_error;break;case-601:r=wpuf_frontend_upload.plupload.type_error;break;default:r="Error #"+i.code+": "+i.message}alert(r),this.count-=1,this.showHide(),this.uploader.refresh()},uploaded:function(t,i,r){if(e("#"+i.id+" b").html("100%"),e("#"+i.id).remove(),"error"!==r.response){this.perFileCount++;var o=e("#"+this.container).find(".wpuf-attachment-list");if(o.append(r.response),this.perFileCount>this.max){var n=e(".wpuf-image-wrap:last a.attachment-delete",o).data("attach_id");this.removeExtraAttachment(n),e(".wpuf-image-wrap",o).last().remove(),this.perFileCount--}}else alert(r.error),this.count-=1,this.showHide()},removeAttachment:function(t){t.preventDefault();var i=this,r=e(t.currentTarget);if(confirm(wpuf_frontend_upload.confirmMsg)){var o={attach_id:r.data("attach_id"),nonce:wpuf_frontend_upload.nonce,action:"wpuf_file_del"};this.removed_files.push(o),jQuery.post(wpuf_frontend_upload.ajaxurl,o,function(){i.perFileCount--,r.parent().parent().remove(),i.count-=1,i.showHide(),i.uploader.refresh()})}},removeExtraAttachment:function(e){var t=this,i={attach_id:e,nonce:wpuf_frontend_upload.nonce,action:"wpuf_file_del"};this.removed_files.push(i),jQuery.post(wpuf_frontend_upload.ajaxurl,i,function(){t.count-=1,t.showHide(),t.uploader.refresh()})}}}(jQuery);